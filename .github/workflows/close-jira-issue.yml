name: Move Jira Ticket to Done on PR Close

on:
  pull_request:
    types: [closed]

permissions:
  pull-requests: write

jobs:
  move-jira-done:
    runs-on: ubuntu-latest
    steps:
      - name: Move Jira Ticket to Done
        uses: actions/github-script@v7
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jiraDomain = 'nuggudi.atlassian.net';
            const pr = context.payload.pull_request;
            const title = pr.title;

            const match = title.match(/NUGUDI-\d+/);
            if (!match) {
              console.log("PR ì œëª©ì—ì„œ Jira í‹°ì¼“ ë„˜ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!ğŸ‘€");
              return;
            }

            const ticket = match[0];

            // Jira transition ëª©ë¡ ì¡°íšŒ
            const transitionsRes = await fetch(`https://${jiraDomain}/rest/api/3/issue/${ticket}/transitions`, {
              method: 'GET',
              headers: {
                'Authorization': `Basic ${Buffer.from(process.env.JIRA_EMAIL + ':' + process.env.JIRA_TOKEN).toString('base64')}`,
                'Accept': 'application/json'
              }
            });

            const transitions = await transitionsRes.json();

            // 'Done' ìƒíƒœì˜ transitionId ì°¾ê¸°
            const doneTransition = transitions.transitions.find(t => t.name === 'Done');
            if (!doneTransition) {
              console.log("Done ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. transition í™•ì¸ í•„ìš”");
              return;
            }

            // ìƒíƒœ ë³€ê²½
            await fetch(`https://${jiraDomain}/rest/api/3/issue/${ticket}/transitions`, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${Buffer.from(process.env.JIRA_EMAIL + ':' + process.env.JIRA_TOKEN).toString('base64')}`,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                transition: {
                  id: doneTransition.id
                }
              })
            });

            console.log(`Jira í‹°ì¼“ ${ticket} ì´ Done ìƒíƒœë¡œ ë³€ê²½ë¨ âœ…`);
